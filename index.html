<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Basic Lighting Calculation Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            /* Enhanced Color System */
            --primary-50: #f0f8ff;
            --primary-100: #e6f7ff;
            --primary-500: #0078d4;
            --primary-600: #005fa3;
            --primary-700: #004578;
            
            /* Neutral Colors */
            --neutral-50: #f8f9fa;
            --neutral-100: #f1f3f4;
            --neutral-200: #e5e7eb;
            --neutral-500: #6b7280;
            --neutral-700: #374151;
            --neutral-900: #111827;
            
            /* Semantic Colors */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            
            /* Spacing Scale */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 0.75rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Legacy variables for compatibility */
            --accent: #0078d4;
            --accent-2: #00c6fb;
            --success-old: #28a745;
            --warning-old: #ffc107;
            --danger: #dc3545;
        }

        /* Modern CSS Reset */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: var(--space-4);
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            background: #fff;
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            max-width: min(800px, 95dvw);
            margin: var(--space-2) auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--neutral-200);
        }

        h1 {
            text-align: center;
            color: var(--primary-700);
            font-size: clamp(1.5rem, 4vw, 1.8rem);
            margin-bottom: var(--space-3);
            letter-spacing: -0.025em;
            font-weight: 700;
        }

        .tool-summary {
            text-align: center;
            color: var(--neutral-700);
            font-size: 0.95rem;
            margin-bottom: var(--space-6);
            padding: 0 var(--space-4);
            line-height: 1.625;
        }

        form label {
            display: block;
            margin-top: var(--space-4);
            font-weight: 600;
            color: var(--neutral-900);
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            margin-top: var(--space-1);
            border-radius: var(--radius-md);
            border: 1.5px solid var(--neutral-200);
            font-size: 0.95rem;
            background: var(--neutral-50);
            transition: all var(--transition-fast);
        }

        input:focus, select:focus {
            border-color: var(--primary-500);
            outline: none;
            box-shadow: 0 0 0 3px rgb(0 120 212 / 0.1);
            background: white;
        }

        /* Modern focus-visible support */
        input:focus-visible, select:focus-visible {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
        }

        button[type="submit"] {
            margin-top: var(--space-6);
            padding: var(--space-4) 0;
            border: none;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        button[type="submit"]:hover {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        button[type="submit"]:active {
            transform: translateY(0);
        }

        .result {
            margin-top: var(--space-6);
            background: var(--primary-50);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            font-size: 0.95rem;
            color: var(--neutral-900);
            animation: fadeIn 0.7s;
            border: 1px solid var(--primary-100);
        }

        .result strong {
            color: var(--primary-600);
        }

        .result table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-4);
            background: #fff;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--neutral-200);
        }

        .result th, .result td {
            padding: var(--space-2) var(--space-3);
            border-bottom: 1px solid var(--neutral-200);
            text-align: center;
        }

        .result th {
            background: var(--primary-50);
            color: var(--primary-600);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .error {
            color: var(--error);
            font-size: 0.8rem;
            margin-top: var(--space-1);
            display: none;
            font-weight: 500;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            margin-bottom: var(--space-2);
            background: var(--primary-50);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            gap: var(--space-2);
            width: fit-content;
            border: 1px solid var(--primary-100);
        }

        .toggle-group span {
            font-weight: 600;
            margin-right: var(--space-1);
            font-size: 0.9rem;
            color: var(--neutral-700);
        }

        .toggle-group input[type="radio"] {
            margin: 0 var(--space-2) 0 var(--space-3);    
            width: 16px;            
            height: 16px;
        }

        .toggle-group label {
            margin: 0 var(--space-1) 0 0;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--neutral-700);
        }

        .form-section {
            background: var(--neutral-50);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-top: var(--space-4);
            border: 1px solid var(--neutral-200);
        }

        .form-section h3 {
            margin-top: 0;
            color: var(--primary-600);
            margin-bottom: var(--space-3);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .note {
            font-size: 0.8rem;
            color: var(--neutral-500);
            margin-top: var(--space-1);
            font-style: italic;
            line-height: 1.4;
        }

        .vertical-fields {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .summary {
            margin-top: var(--space-6);
            background: var(--primary-50);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--primary-500);
            display: none;
            border: 1px solid var(--primary-100);
        }

        .summary h3 {
            margin-top: 0;
            color: var(--primary-600);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .summary-content {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-4);
        }

        .summary-item {
            flex: 1;
            min-width: 120px;
            text-align: center;
            padding: var(--space-3);
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--neutral-200);
        }

        .summary-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-500);
            margin: var(--space-1) 0;
        }

        .summary-label {
            font-size: 0.8rem;
            color: var(--neutral-600);
            font-weight: 500;
        }
        
        /* Layout Visualization Styles */
        .layout-container {
            margin-top: var(--space-6);
            background: white;
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
        }

        .layout-visualization {
            width: 100%;
            height: 300px;
            background: var(--neutral-50);
            border: 2px solid var(--primary-500);
            border-radius: var(--radius-lg);
            position: relative;
            margin: var(--space-4) 0;
            overflow: hidden;
        }

        .room-outline {
            position: absolute;
            border: 2px solid var(--neutral-700);
            background: rgba(255,255,255,0.95);
        }

        .luminaire {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff6b35;
            border-radius: 50%;
            border: 2px solid #ff4500;
            transform: translate(-50%, -50%);
            box-shadow: var(--shadow-sm);
        }

        .luminaire::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(255,107,53,0.3) 0%, rgba(255,107,53,0) 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .layout-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0,120,212,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,120,212,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .layout-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .layout-card {
            background: var(--primary-50);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-500);
            border: 1px solid var(--primary-100);
        }

        .layout-card h4 {
            margin: 0 0 var(--space-2) 0;
            color: var(--primary-600);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .layout-card p {
            margin: var(--space-1) 0;
            font-size: 0.85rem;
            color: var(--neutral-700);
        }

        .spacing-info {
            background: var(--primary-100);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            margin-top: var(--space-3);
        }

        .recommendation {
            background: #fff3cd;
            border-left: 4px solid var(--warning);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin: var(--space-3) 0;
            border: 1px solid #ffeaa7;
        }

        /* Navigation Styles */
        .page-navigation {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-6);
            background: white;
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            gap: var(--space-2);
        }
        
        .nav-button {
            padding: var(--space-3) var(--space-6);
            margin: 0;
            border: 2px solid var(--primary-500);
            background: white;
            color: var(--primary-500);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all var(--transition-normal);
            flex: 1;
            max-width: 150px;
        }
        
        .nav-button.active {
            background: var(--primary-500);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .nav-button:hover:not(.active) {
            background: var(--primary-50);
            transform: translateY(-1px);
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        .info-page {
            background: var(--neutral-50);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            margin-top: var(--space-6);
            border: 1px solid var(--neutral-200);
        }
        
        .info-section {
            margin-bottom: var(--space-8);
        }
        
        .info-section h3 {
            color: var(--primary-600);
            border-bottom: 2px solid var(--primary-500);
            padding-bottom: var(--space-2);
            margin-bottom: var(--space-4);
            font-weight: 600;
        }
        
        .info-section ul {
            padding-left: var(--space-6);
        }
        
        .info-section li {
            margin-bottom: var(--space-2);
            line-height: 1.5;
        }

        /* Objective Button Styles */
        .objective-buttons {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        
        .objective-button {
            flex: 1;
            padding: var(--space-6) var(--space-4);
            border: 2px solid var(--primary-500);
            border-radius: var(--radius-lg);
            background: white;
            color: var(--primary-500);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }
        
        .objective-button:hover {
            background: var(--primary-50);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .objective-button.active {
            background: var(--primary-500);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .objective-button .icon {
            font-size: 1.5rem;
            margin-bottom: var(--space-2);
            display: block;
        }
        
        .objective-button .description {
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: var(--space-1);
            opacity: 0.8;
        }

        /* Formula Styling */
        .formula-box {
            background: var(--primary-50);
            border-left: 4px solid var(--primary-500);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin: var(--space-4) 0;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            border: 1px solid var(--primary-100);
        }
        
        .formula-box strong {
            color: var(--primary-600);
        }

        .copy-btn {
            margin-top: var(--space-4);
            padding: var(--space-3) var(--space-6);
            border: none;
            border-radius: var(--radius-md);
            background: var(--success);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-normal);
            font-weight: 600;
        }

        .copy-btn:hover {
            background: #0da271;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .copy-btn.copied {
            background: #0c955f;
        }

        /* Quick Presets */
        .preset-buttons {
            display: flex;
            gap: var(--space-2);
            margin: var(--space-3) 0;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            padding: var(--space-2) var(--space-3);
            border: 1.5px solid var(--primary-500);
            border-radius: var(--radius-md);
            background: white;
            color: var(--primary-500);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-weight: 500;
        }
        
        .preset-btn:hover {
            background: var(--primary-50);
            transform: translateY(-1px);
        }
        
        .preset-btn.active {
            background: var(--primary-500);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* Input Helpers */
        .input-with-helper {
            position: relative;
        }
        
        .helper-text {
            font-size: 0.75rem;
            color: var(--neutral-500);
            margin-top: var(--space-1);
            display: block;
            line-height: 1.3;
        }
        
        .auto-calc-btn {
            position: absolute;
            right: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-500);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--space-1) var(--space-2);
            font-size: 0.7rem;
            cursor: pointer;
            font-weight: 500;
            transition: background var(--transition-fast);
        }

        .auto-calc-btn:hover {
            background: var(--primary-600);
        }

        /* Loading State */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--neutral-200);
            border-top: 3px solid var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: var(--space-3);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        /* Mobile responsiveness with modern viewport units */
        @media (max-width: 768px) {
            body {
                padding: var(--space-2);
            }
            
            .container {
                padding: var(--space-4);
                margin: var(--space-1) auto;
            }
            
            .summary-content {
                flex-direction: column;
            }
            
            .summary-item {
                min-width: 100%;
            }
            
            .layout-info {
                grid-template-columns: 1fr;
            }
            
            .toggle-group {
                flex-wrap: wrap;
                width: 100%;
            }
            
            .objective-buttons {
                flex-direction: column;
            }
            
            .page-navigation {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-button {
                max-width: 200px;
                width: 100%;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Print Styles */
        @media print {
            .page-navigation, button, .preset-buttons {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
                margin: 0;
                padding: var(--space-2);
                border: none;
            }
            
            .result, .summary, .layout-container {
                break-inside: avoid;
            }
            
            /* Keep lights visible in print */
            .luminaire {
                background: #ff6b35 !important;
                border: 2px solid #ff4500 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Ensure layout visualization is visible */
            .layout-visualization {
                border: 2px solid var(--primary-500) !important;
                background: var(--neutral-50) !important;
            }
            
            /* Keep room outline visible */
            .room-outline {
                border: 2px solid var(--neutral-700) !important;
                background: rgba(255,255,255,0.9) !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="page-navigation">
            <button class="nav-button active" data-page="calculator">Calculator</button>
            <button class="nav-button" data-page="info">Information</button>
            <button class="nav-button" data-page="examples">Examples</button>
        </div>
        
        <!-- Calculator Page -->
        <div class="page active" id="calculator-page">
            <h1>Basic Lighting Calculation Tool</h1>
            
            <div class="tool-summary">
                This tool helps you calculate lighting requirements for indoor spaces and provides optimal 
                lighting layout suggestions based on room dimensions and lighting parameters using Lumen Method.
                 Results are specifically calibrated for wide-beam (100¬∞) LED fixtures to ensure 
                    alignment with Dialux software standards.
            </div>

            <form id="lightingForm">
                <!-- Updated Calculation Objective Section -->
                <div class="form-section">
                    <h3>Calculation Objective</h3>
                    <div class="objective-buttons">
                        <div class="objective-button active" data-objective="calcLuminaires">
                            <span class="icon">üí°</span>
                            Calculate Number of Luminaires
                        </div>
                        <div class="objective-button" data-objective="calcLux">
                            <span class="icon">üìä</span>
                            Calculate Lux Level
                        </div>
                    </div>
                    <input type="hidden" id="objective" name="objective" value="calcLuminaires">
                </div>

                <div class="toggle-group">
                    <span>Unit:</span>
                    <input type="radio" id="unitMm" name="unit" value="mm">
                    <label for="unitMm">mm</label>
                    <input type="radio" id="unitMeters" name="unit" value="meters" checked>
                    <label for="unitMeters">Meters</label>
                    <input type="radio" id="unitFeet" name="unit" value="feet">
                    <label for="unitFeet">Feet</label>
                </div>
                
                <div class="form-section">
                    <h3>Space Dimensions <span id="spaceUnitLabel">(meters)</span></h3>
                    
                    <!-- Room Presets -->
                    <div class="preset-buttons">
                        <button type="button" class="preset-btn" data-preset="small">Small Room</button>
                        <button type="button" class="preset-btn" data-preset="medium">Medium Room</button>
                        <button type="button" class="preset-btn" data-preset="large">Large Room</button>
                        <button type="button" class="preset-btn" data-preset="office">Office</button>
                        <button type="button" class="preset-btn" data-preset="classroom">Classroom</button>
                    </div>
                    
                    <div class="vertical-fields">
                        <label>Length:
                            <input type="number" step="0.1" min="0" id="length" placeholder="Enter length" required>
                            <span class="helper-text">Typical: 3-6m for rooms, 8-12m for classrooms</span>
                            <span class="error" id="lengthError">Please enter a non-negative value</span>
                        </label>
                        <label>Width:
                            <input type="number" step="0.1" min="0" id="width" placeholder="Enter width" required>
                            <span class="helper-text">Typical: 3-5m for rooms, 6-8m for classrooms</span>
                            <span class="error" id="widthError">Please enter a non-negative value</span>
                        </label>
                        <label>Height:
                            <input type="number" step="0.1" min="0" id="height" placeholder="Enter height" required>
                            <span class="helper-text">Typical: 2.4-3m for residential, 3-4m for commercial</span>
                            <span class="error" id="heightError">Please enter a non-negative value</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Lighting Requirements</h3>
                    <div id="targetLuxContainer">
                        <div class="note">(Select a room type to autofill the recommended lux value, or choose "Custom" to input your own)</div>
                        <label>Room Type:
                            <select id="roomType">
                                <option value="100">Corridor / Hallway</option>
                                <option value="50">Bedroom</option>
                                <option value="100">Bathroom</option>
                                <option value="150">Living Room</option>
                                <option value="500">Office / Study</option>
                                <option value="300">Kitchen</option>
                                <option value="500">Classroom</option>
                                <option value="500">Multipurpose Hall</option>
                                <option value="500">Retail / Shop</option>
                                <option value="750">Laboratory</option>
                                <option value="custom" selected>Custom</option>
                            </select>
                        </label>
                        <label>Target Illuminance (lux):
                            <input type="number" min="0" id="targetLux" placeholder="Enter target lux" required>
                            <span class="error" id="luxError">Please enter a non-negative lux value</span>
                        </label>
                    </div>
                    <div id="numLuminairesContainer" style="display: none;">
                        <label>Number of Luminaires:
                            <input type="number" min="1" step="1" id="numLuminairesInput" placeholder="Enter quantity of lights">
                            <span class="error" id="numLuminairesError">Please enter a positive whole number</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Light Specifications</h3>
                    <div class="note">(Choose a predefined light source type with preset lumen value, or select "Custom" to input your own)</div>
                    
                    <label>Light Source:
                        <select id="lightSource" required>
                            <option value="predefined">Predefined type</option>
                            <option value="custom" selected>Custom</option>
                        </select>
                    </label>
                    <div id="predefinedLights" style="display: none;">
                        <label>Type of Lights:
                            <select id="lightType">
                                <option value="1000">LED (1000 lm)</option>
                                <option value="800">Incandescent (800 lm)</option>
                                <option value="900">Fluorescent (900 lm)</option>
                                <option value="1500">High-output LED (1500 lm)</option>
                                <option value="2000">Commercial LED (2000 lm)</option>
                            </select>
                        </label>
                    </div>
                    <div id="customLumens">
                        <label>Lumens:
                            <input type="number" min="0" id="customLumensInput" placeholder="Enter lumens" required>
                            <span class="helper-text">Typical: 800-1100 lm for 60W LED equivalent</span>
                            <span class="error" id="lumensError">Please enter a non-negative lumen value</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Installation Parameters</h3>
                    <div class="vertical-fields">
                        <label class="input-with-helper">Mounting Height:
                            <input type="number" step="0.1" min="0" id="mountingHeight" placeholder="Enter mounting height" required>
                            <button type="button" class="auto-calc-btn" title="Set to standard ceiling height">Auto</button>
                            <span class="helper-text">Distance from floor to light fixture</span>
                            <span class="error" id="mountingHeightError">Please enter a non-negative value</span>
                            <span class="error" id="mountingHeightRoomError" style="display: none;">Mounting height must be less or equal to room height</span>
                        </label>
                        <label class="input-with-helper">Working Plane Height:
                            <input type="number" step="0.1" min="0" id="workingPlaneHeight" placeholder="Enter working plane height" required>
                            <button type="button" class="auto-calc-btn" title="Set to standard desk height">Auto</button>
                            <span class="helper-text">Typically 0.8m for desks, 0m for floor illumination</span>
                            <span class="error" id="workingPlaneError">Please enter a non-negative value</span>
                            <span class="error" id="workingPlaneMountingError" style="display: none;">Working plane height must be equal or less than mounting height</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Surface Reflectance</h3>
                    
                    <!-- Reflectance Presets -->
                    <div class="preset-buttons">
                        <button type="button" class="preset-btn" data-reflectance="light">Light Colors</button>
                        <button type="button" class="preset-btn" data-reflectance="medium">Medium Colors</button>
                        <button type="button" class="preset-btn" data-reflectance="dark">Dark Colors</button>
                    </div>
                    
                    <div class="vertical-fields">
                        <label>Ceiling:
                            <input type="number" step="0.01" min="0" max="1" id="ceilingReflect" placeholder="0.8" value="0.8" required>
                            <span class="helper-text">0.8 for white, 0.7 for light colors, 0.5 for dark</span>
                            <span class="error" id="ceilingError">Please enter a value between 0 and 1</span>
                        </label>
                        <label>Wall:
                            <input type="number" step="0.01" min="0" max="1" id="wallReflect" placeholder="0.5" value="0.5" required>
                            <span class="helper-text">0.7 for light walls, 0.5 for medium, 0.3 for dark</span>
                            <span class="error" id="wallError">Please enter a value between 0 and 1</span>
                        </label>
                        <label>Floor:
                            <input type="number" step="0.01" min="0" max="1" id="floorReflect" placeholder="0.2" value="0.2" required>
                            <span class="helper-text">0.2 for typical floors</span>
                            <span class="error" id="floorError">Please enter a value between 0 and 1</span>
                        </label>
                    </div>
                </div>
                
                <button type="submit" id="submitBtn">
                    <span class="spinner" id="submitSpinner" style="display: none;"></span>
                    Calculate Number of Luminaires
                </button>
            </form>
            
            <div class="summary" id="summary">
                <h3>Quick Summary</h3>
                <div class="summary-content" id="summaryContent">
                    <!-- Summary items will be added dynamically -->
                </div>
            </div>
            
            <div class="result" id="result" style="display:none;"></div>
            
            <!-- Print and Copy Buttons -->
            <div style="margin-top: 15px; display: none;" id="actionButtons">
                <button class="copy-btn" id="copyBtn">üìã Copy Results</button>
                <button class="copy-btn" id="printBtn" style="background: #6c757d; margin-left: 10px;">üñ®Ô∏è Print Results</button>
            </div>
            
            <!-- Layout Suggestions Section -->
            <div class="layout-container" id="layoutContainer" style="display: none;">
                <h3>üèóÔ∏è Lighting Layout Visualization</h3>
                <div class="layout-visualization" id="layoutVisualization">
                    <div class="layout-grid"></div>
                    <!-- Room outline and luminaires will be added dynamically -->
                </div>
                <div class="layout-info" id="layoutInfo">
                    <!-- Layout details will be added dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Information Page -->
        <div class="page" id="info-page">
            <h1>Lighting Design Information</h1>
            
            <div class="info-page">
                <div class="info-section">
                    <h3>Calculation Method</h3>
                    <p>This tool uses the Lumen Method formula calibrated to align with industry-standard Dialux software 
                        for accuracy:</p>
                    <div class="formula-box">
                        <strong>N = ( E √ó A ) / ( F √ó UF √ó MF √ó 1.097 )</strong>
                    </div>
                    <p>Where:</p>
                    <ul>
                        <li><strong>N</strong> = Number of luminaires</li>
                        <li><strong>E</strong> = Required illuminance (lux)</li>
                        <li><strong>A</strong> = Area (m¬≤)</li>
                        <li><strong>F</strong> = Luminous flux per luminaire (lumens)</li>
                        <li><strong>UF</strong> = Utilization factor</li>
                        <li><strong>MF</strong> = Maintenance factor</li>
                        <li><strong>1.097</strong> = Dialux alignment multiplier</li>
                    </ul>
                    <p><strong>Note:</strong> The calculation is specifically calibrated for modern LED 
                        luminaires with a wide 100-degree beam angle. This calibration ensures results are consistent with detailed 
                        simulation software, accounting for the complex light distribution of contemporary fixtures.</p>
                </div>
                
                <div class="info-section">
                    <h3>About Lux Levels</h3>
                    <p>Lux (lx) is the SI unit of illuminance, measuring luminous flux per unit area. One lux is equal to one lumen per square meter.</p>
                    <p><strong>Common Lux Requirements:</strong></p>
                    <ul>
                        <li>Corridors: 100-150 lux</li>
                        <li>Offices: 300-500 lux</li>
                        <li>Classrooms: 300-500 lux</li>
                        <li>Kitchens: 400-500 lux</li>
                        <li>Detailed Work: 750-1000 lux</li>
                    </ul>
                </div>
                
                <div class="info-section">
                    <h3>Understanding Lumens</h3>
                    <p>Lumens measure the total amount of visible light emitted by a source. Higher lumen values mean brighter lights.</p>
                    <p><strong>Typical Lumen Values:</strong></p>
                    <ul>
                        <li>LED Bulb (60W equivalent): 800-1100 lumens</li>
                        <li>Fluorescent Tube (4ft): 2000-3000 lumens</li>
                        <li>Commercial LED Panel: 3000-4000 lumens</li>
                    </ul>
                </div>

                <div class="info-section">
                    <h3>Lighting Layout Principles</h3>
                    <p><strong>Key Spacing Guidelines:</strong></p>
                    <ul>
                        <li><strong>Spacing to Height Ratio (SHR):</strong> Typically 1.0-1.5 for uniform lighting</li>
                        <li><strong>Wall Distance:</strong> Luminaires should be 1/3 to 1/2 of spacing from walls</li>
                        <li><strong>Grid Patterns:</strong> Rectangular or square grids for uniform illumination</li>
                        <li><strong>Avoid Shadows:</strong> Strategic placement to minimize shadows in work areas</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Examples Page -->
        <div class="page" id="examples-page">
            <h1>Lighting Calculation Examples</h1>
            
            <div class="info-page">
                <div class="info-section">
                    <h3>Example 1: Office Lighting</h3>
                    <p><strong>Scenario:</strong> Lighting a 6m √ó 5m office space</p>
                    <p><strong>Requirements:</strong> 400 lux for office work</p>
                    <p><strong>Solution:</strong></p>
                    <ul>
                        <li>Area: 30 m¬≤</li>
                        <li>LED panels (3000 lumens each)</li>
                        <li>Utilization factor: 0.65</li>
                        <li>Maintenance factor: 0.8</li>
                        <li><strong>Calculation:</strong> (400 √ó 30) / (3000 √ó 0.65 √ó 0.8 √ó 1.097) = 7.0 ‚Üí 7 luminaires</li>
                        <li><strong>Layout:</strong> Appropriate grid based on room dimensions</li>
                    </ul>
                </div>
                
                <div class="info-section">
                    <h3>Example 2: Classroom Lighting</h3>
                    <p><strong>Scenario:</strong> Lighting a 8m √ó 6m classroom</p>
                    <p><strong>Requirements:</strong> 500 lux for reading and writing</p>
                    <p><strong>Solution:</strong></p>
                    <ul>
                        <li>Area: 48 m¬≤</li>
                        <li>LED tubes (1800 lumens each)</li>
                        <li>Utilization factor: 0.7</li>
                        <li>Maintenance factor: 0.8</li>
                        <li><strong>Calculation:</strong> (500 √ó 48) / (1800 √ó 0.7 √ó 0.8 √ó 1.097) = 21.7 ‚Üí 22 luminaires</li>
                        <li><strong>Layout:</strong> Appropriate grid based on room dimensions</li>
                    </ul>
                </div>
                
                <div class="info-section">
                    <h3>Quick Reference Table</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background: #0078d4; color: white;">
                                <th style="padding: 10px; text-align: left;">Room Type</th>
                                <th style="padding: 10px; text-align: left;">Recommended Lux</th>
                                <th style="padding: 10px; text-align: left;">Typical Fixtures</th>
                                <th style="padding: 10px; text-align: left;">Layout Pattern</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px;">Residential Living</td>
                                <td style="padding: 10px;">150-300 lux</td>
                                <td style="padding: 10px;">LED downlights, pendants</td>
                                <td style="padding: 10px;">Perimeter + central</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px;">Office Space</td>
                                <td style="padding: 10px;">300-500 lux</td>
                                <td style="padding: 10px;">LED panels, troffers</td>
                                <td style="padding: 10px;">Uniform grid</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px;">Retail</td>
                                <td style="padding: 10px;">500-750 lux</td>
                                <td style="padding: 10px;">Track lighting, spots</td>
                                <td style="padding: 10px;">Accent + general</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px;">Industrial</td>
                                <td style="padding: 10px;">750-1000 lux</td>
                                <td style="padding: 10px;">High bay fixtures</td>
                                <td style="padding: 10px;">Wide spacing grid</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('length').focus();
            
            // Page navigation functionality
            const navButtons = document.querySelectorAll('.nav-button');
            const pages = document.querySelectorAll('.page');
            
            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetPage = this.getAttribute('data-page');
                    
                    // Update active button
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show target page
                    pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(`${targetPage}-page`).classList.add('active');
                });
            });

            // Room Presets
            const roomPresets = {
                small: { length: 3, width: 3, height: 2.4 },
                medium: { length: 5, width: 4, height: 2.7 },
                large: { length: 8, width: 6, height: 3 },
                office: { length: 6, width: 5, height: 2.8 },
                classroom: { length: 10, width: 8, height: 3.2 }
            };

            const reflectancePresets = {
                light: { ceiling: 0.8, wall: 0.7, floor: 0.2 },
                medium: { ceiling: 0.7, wall: 0.5, floor: 0.2 },
                dark: { ceiling: 0.5, wall: 0.3, floor: 0.2 }
            };

            // Room preset buttons
            document.querySelectorAll('.preset-btn[data-preset]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const preset = this.getAttribute('data-preset');
                    const values = roomPresets[preset];
                    
                    document.getElementById('length').value = values.length;
                    document.getElementById('width').value = values.width;
                    document.getElementById('height').value = values.height;
                    
                    // Auto-set mounting and working heights
                    document.getElementById('mountingHeight').value = (values.height - 0.2).toFixed(1);
                    document.getElementById('workingPlaneHeight').value = '0.8';
                    
                    // Update active state
                    document.querySelectorAll('.preset-btn[data-preset]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Reflectance preset buttons
            document.querySelectorAll('.preset-btn[data-reflectance]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const preset = this.getAttribute('data-reflectance');
                    const values = reflectancePresets[preset];
                    
                    document.getElementById('ceilingReflect').value = values.ceiling;
                    document.getElementById('wallReflect').value = values.wall;
                    document.getElementById('floorReflect').value = values.floor;
                    
                    // Update active state
                    document.querySelectorAll('.preset-btn[data-reflectance]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Auto-calculate buttons for heights
            document.querySelectorAll('.auto-calc-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const field = this.parentElement.querySelector('input');
                    if (field.id === 'mountingHeight') {
                        const roomHeight = parseFloat(document.getElementById('height').value);
                        if (!isNaN(roomHeight) && roomHeight > 0) {
                            field.value = (roomHeight - 0.2).toFixed(1);
                        }
                    } else if (field.id === 'workingPlaneHeight') {
                        field.value = '0.8'; // Standard desk height
                    }
                });
            });

            // Input validation with real-time feedback
            function setupRealTimeValidation() {
                const inputs = document.querySelectorAll('input[type="number"]');
                inputs.forEach(input => {
                    input.addEventListener('blur', function() {
                        validateField(this);
                    });
                    
                    // Real-time validation for critical fields
                    if (['mountingHeight', 'workingPlaneHeight', 'height'].includes(input.id)) {
                        input.addEventListener('input', function() {
                            validateHeightRelations();
                        });
                    }
                });
            }

            function validateField(field) {
                const errorSpan = document.getElementById(field.id + 'Error');
                if (!errorSpan) return;

                const value = parseFloat(field.value);
                const min = parseFloat(field.min) || 0;
                const max = parseFloat(field.max);

                let isValid = !isNaN(value) && value >= min;
                if (max) isValid = isValid && value <= max;

                errorSpan.style.display = isValid ? 'none' : 'block';
                field.style.borderColor = isValid ? '#cfd8dc' : '#d32f2f';
                
                return isValid;
            }

            function validateHeightRelations() {
                const height = parseFloat(document.getElementById('height').value);
                const mountingHeight = parseFloat(document.getElementById('mountingHeight').value);
                const workingHeight = parseFloat(document.getElementById('workingPlaneHeight').value);

                const mountingError = document.getElementById('mountingHeightRoomError');
                const workingError = document.getElementById('workingPlaneMountingError');

                if (!isNaN(height) && !isNaN(mountingHeight) && mountingHeight > height) {
                    mountingError.style.display = 'block';
                } else {
                    mountingError.style.display = 'none';
                }

                if (!isNaN(mountingHeight) && !isNaN(workingHeight) && workingHeight >= mountingHeight) {
                    workingError.style.display = 'block';
                } else {
                    workingError.style.display = 'none';
                }
            }

            // New Objective Button Functionality
            const objectiveButtons = document.querySelectorAll('.objective-button');
            const objectiveInput = document.getElementById('objective');
            
            objectiveButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const objective = this.getAttribute('data-objective');
                    
                    // Update active button
                    objectiveButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update hidden input
                    objectiveInput.value = objective;
                    
                    // Update form display
                    toggleCalculationMode();
                });
            });

            // Constants for unit conversion
            const METERS_TO_FEET = 3.28084;
            const FEET_TO_METERS = 0.3048;
            const MM_TO_METERS = 0.001;
            
            // Dialux alignment multiplier
            const DIALUX_MULTIPLIER = 1.097;
            
            // Simplified UF table with direct lookup
            const ufTable = {
                0.6: { 0.5: {0.3: 0.49, 0.5: 0.54, 0.7: 0.61}, 0.7: {0.3: 0.50, 0.5: 0.55, 0.7: 0.63}, 0.8: {0.3: 0.50, 0.5: 0.55, 0.7: 0.64} },
                0.8: { 0.5: {0.3: 0.61, 0.5: 0.65, 0.7: 0.71}, 0.7: {0.3: 0.61, 0.5: 0.66, 0.7: 0.73}, 0.8: {0.3: 0.62, 0.5: 0.67, 0.7: 0.74} },
                1.0: { 0.5: {0.3: 0.68, 0.5: 0.72, 0.7: 0.77}, 0.7: {0.3: 0.69, 0.5: 0.73, 0.7: 0.79}, 0.8: {0.3: 0.69, 0.5: 0.74, 0.7: 0.80} },
                1.25:{ 0.5: {0.3: 0.74, 0.5: 0.77, 0.7: 0.81}, 0.7: {0.3: 0.75, 0.5: 0.79, 0.7: 0.84}, 0.8: {0.3: 0.76, 0.5: 0.80, 0.7: 0.85} },
                1.5: { 0.5: {0.3: 0.78, 0.5: 0.81, 0.7: 0.84}, 0.7: {0.3: 0.79, 0.5: 0.83, 0.7: 0.87}, 0.8: {0.3: 0.80, 0.5: 0.84, 0.7: 0.89} },
                2.0: { 0.5: {0.3: 0.81, 0.5: 0.84, 0.7: 0.87}, 0.7: {0.3: 0.83, 0.5: 0.86, 0.7: 0.90}, 0.8: {0.3: 0.84, 0.5: 0.87, 0.7: 0.91} },
                2.5: { 0.5: {0.3: 0.83, 0.5: 0.86, 0.7: 0.88}, 0.7: {0.3: 0.86, 0.5: 0.88, 0.7: 0.91}, 0.8: {0.3: 0.87, 0.5: 0.90, 0.7: 0.93} },
                3.0: { 0.5: {0.3: 0.85, 0.5: 0.87, 0.7: 0.89}, 0.7: {0.3: 0.87, 0.5: 0.90, 0.7: 0.92}, 0.8: {0.3: 0.88, 0.5: 0.91, 0.7: 0.94} },
                4.0: { 0.5: {0.3: 0.87, 0.5: 0.88, 0.7: 0.90}, 0.7: {0.3: 0.89, 0.5: 0.91, 0.7: 0.94}, 0.8: {0.3: 0.91, 0.5: 0.93, 0.7: 0.96} }
            };
            
            // DOM elements
            const unitRadios = document.querySelectorAll('input[name="unit"]');
            const spaceUnitLabel = document.getElementById('spaceUnitLabel');
            const roomTypeSelect = document.getElementById('roomType');
            const targetLuxInput = document.getElementById('targetLux');
            const numLuminairesInput = document.getElementById('numLuminairesInput');
            const targetLuxContainer = document.getElementById('targetLuxContainer');
            const numLuminairesContainer = document.getElementById('numLuminairesContainer');
            const lightSourceSelect = document.getElementById('lightSource');
            const predefinedLightsDiv = document.getElementById('predefinedLights');
            const customLumensDiv = document.getElementById('customLumens');
            const customLumensInput = document.getElementById('customLumensInput');
            const submitBtn = document.getElementById('submitBtn');
            const submitSpinner = document.getElementById('submitSpinner');
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summaryContent');
            const layoutContainer = document.getElementById('layoutContainer');
            const layoutVisualization = document.getElementById('layoutVisualization');
            const layoutInfo = document.getElementById('layoutInfo');
            const actionButtons = document.getElementById('actionButtons');
            const copyBtn = document.getElementById('copyBtn');
            const printBtn = document.getElementById('printBtn');
            
            function initializeForm() {
                document.getElementById('length').value = '5';
                document.getElementById('width').value = '4';
                document.getElementById('height').value = '3';
                document.getElementById('mountingHeight').value = '2.5';
                document.getElementById('workingPlaneHeight').value = '0.8';
                document.getElementById('targetLux').value = '300';
                customLumensInput.value = '1000';
                predefinedLightsDiv.style.display = 'none';
                customLumensDiv.style.display = 'block';
                toggleCalculationMode();
                setupRealTimeValidation();
            }
            
            function toggleCalculationMode() {
                const selectedMode = objectiveInput.value;
                if (selectedMode === 'calcLuminaires') {
                    targetLuxContainer.style.display = 'block';
                    numLuminairesContainer.style.display = 'none';
                    targetLuxInput.setAttribute('required', 'required');
                    numLuminairesInput.removeAttribute('required');
                    submitBtn.textContent = 'Calculate Number of Luminaires';
                } else {
                    targetLuxContainer.style.display = 'none';
                    numLuminairesContainer.style.display = 'block';
                    targetLuxInput.removeAttribute('required');
                    numLuminairesInput.setAttribute('required', 'required');
                    submitBtn.textContent = 'Calculate Lux Level';
                }
            }

            lightSourceSelect.addEventListener('change', function() {
                const sourceType = this.value;
                predefinedLightsDiv.style.display = sourceType === 'predefined' ? 'block' : 'none';
                customLumensDiv.style.display = sourceType === 'custom' ? 'block' : 'none';
                customLumensInput.required = (sourceType === 'custom');
            });
            
            roomTypeSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    targetLuxInput.value = '';
                    targetLuxInput.readOnly = false;
                } else {
                    targetLuxInput.value = this.value;
                    targetLuxInput.readOnly = true;
                }
            });
            
            unitRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const unit = this.value;
                    if (unit === 'meters') spaceUnitLabel.textContent = '(meters)';
                    else if (unit === 'feet') spaceUnitLabel.textContent = '(feet)';
                    else if (unit === 'mm') spaceUnitLabel.textContent = '(mm)';
                });
            });

            function calculateRoomIndex(length, width, mountingHeight, workingPlaneHeight) {
                const Hm = Math.max(0.1, mountingHeight - workingPlaneHeight);
                return (length * width) / (Hm * (length + width));
            }
            
            function findClosestLowerValue(value, array) {
                const sortedArray = array.slice().sort((a, b) => a - b);
                for (let i = sortedArray.length - 1; i >= 0; i--) {
                    if (sortedArray[i] <= value) return sortedArray[i];
                }
                return sortedArray[0];
            }
            
            function estimateUF(roomIndex, ceilingReflectance, wallReflectance) {
                try {
                    const roomIndices = Object.keys(ufTable).map(Number);
                    const closestRoomIndex = findClosestLowerValue(roomIndex, roomIndices);
                    const ceilingValues = [0.5, 0.7, 0.8];
                    const closestCeiling = findClosestLowerValue(ceilingReflectance, ceilingValues);
                    const wallValues = [0.3, 0.5, 0.7];
                    const closestWall = findClosestLowerValue(wallReflectance, wallValues);
                    return ufTable[closestRoomIndex][closestCeiling][closestWall] || 0.6;
                } catch (error) {
                    console.error("Error estimating UF:", error);
                    return 0.6;
                }
            }

            function calculateLuminaires(targetLux, area, lumensPerFixture, uf, mf = 0.8) {
                if (lumensPerFixture <= 0 || uf <= 0 || mf <= 0) return Infinity;
                return Math.ceil((targetLux * area) / (lumensPerFixture * uf * mf * DIALUX_MULTIPLIER));
            }

            function calculateOptimalLayout(length, width, numLuminaires) {
                if (numLuminaires <= 3) {
                    return {
                        rows: numLuminaires,
                        columns: 1,
                        spacingX: length / 2,
                        spacingY: width / numLuminaires,
                        wallOffsetX: length / 2,
                        wallOffsetY: width / (numLuminaires * 2),
                        totalLuminaires: numLuminaires,
                        layoutType: 'grid',
                        rowPattern: null
                    };
                }

                let bestRows = 1;
                let bestCols = numLuminaires;
                let bestScore = Math.abs((length/width) - (bestCols / bestRows));
                
                for (let rows = 1; rows <= numLuminaires; rows++) {
                    if (numLuminaires % rows === 0) {
                        const cols = numLuminaires / rows;
                        const gridAspectRatio = (cols / rows);
                        const roomAspectRatio = (length / width);
                        const score = Math.abs(roomAspectRatio - gridAspectRatio);
                        
                        if (score < bestScore) {
                            bestScore = score;
                            bestRows = rows;
                            bestCols = cols;
                        }
                    }
                }
                
                if (bestRows * bestCols === numLuminaires && bestRows > 1 && bestCols > 1) {
                    return {
                        rows: bestRows,
                        columns: bestCols,
                        spacingX: length / bestCols,
                        spacingY: width / bestRows,
                        wallOffsetX: (length / bestCols) / 2,
                        wallOffsetY: (width / bestRows) / 2,
                        totalLuminaires: numLuminaires,
                        layoutType: 'grid',
                        rowPattern: null
                    };
                }
                
                const baseCols = Math.ceil(Math.sqrt(numLuminaires));
                const fullRows = Math.floor(numLuminaires / baseCols);
                const remainingLights = numLuminaires % baseCols;
                
                let optimalCols = baseCols;
                if (remainingLights > 0 && remainingLights < baseCols - 2) {
                    for (let cols = baseCols - 1; cols <= baseCols + 1; cols++) {
                        if (cols <= 0) continue;
                        const testFullRows = Math.floor(numLuminaires / cols);
                        const testRemaining = numLuminaires % cols;
                        if (testRemaining === 0 || (testRemaining >= cols - 1 && testFullRows > 1)) {
                            optimalCols = cols;
                            break;
                        }
                    }
                }
                
                const finalFullRows = Math.floor(numLuminaires / optimalCols);
                const finalRemaining = numLuminaires % optimalCols;
                
                const rowPattern = [];
                for (let i = 0; i < finalFullRows; i++) {
                    rowPattern.push(optimalCols);
                }
                if (finalRemaining > 0) {
                    rowPattern.push(finalRemaining);
                }
                
                const totalRows = rowPattern.length;
                const maxCols = Math.max(...rowPattern);
                
                if (maxCols === 1 && numLuminaires > 3) {
                    const newCols = 2;
                    const newFullRows = Math.floor(numLuminaires / newCols);
                    const newRemaining = numLuminaires % newCols;
                    
                    const newRowPattern = [];
                    for (let i = 0; i < newFullRows; i++) {
                        newRowPattern.push(newCols);
                    }
                    if (newRemaining > 0) {
                        newRowPattern.push(newRemaining);
                    }
                    
                    return {
                        rows: newRowPattern.length,
                        columns: Math.max(...newRowPattern),
                        spacingX: length / Math.max(...newRowPattern),
                        spacingY: width / newRowPattern.length,
                        wallOffsetX: (length / Math.max(...newRowPattern)) / 2,
                        wallOffsetY: (width / newRowPattern.length) / 2,
                        totalLuminaires: numLuminaires,
                        layoutType: 'staggered',
                        rowPattern: newRowPattern
                    };
                }
                
                return {
                    rows: totalRows,
                    columns: maxCols,
                    spacingX: length / maxCols,
                    spacingY: width / totalRows,
                    wallOffsetX: (length / maxCols) / 2,
                    wallOffsetY: (width / totalRows) / 2,
                    totalLuminaires: numLuminaires,
                    layoutType: 'staggered',
                    rowPattern: rowPattern
                };
            }

            function generateLayoutVisualization(layout, length, width, unit) {
                const visualization = layoutVisualization;
                visualization.innerHTML = '<div class="layout-grid"></div>';
                
                const roomOutline = document.createElement('div');
                roomOutline.className = 'room-outline';
                roomOutline.style.width = '90%';
                roomOutline.style.height = '90%';
                roomOutline.style.top = '5%';
                roomOutline.style.left = '5%';
                visualization.appendChild(roomOutline);
                
                if (layout.layoutType === 'grid') {
                    for (let row = 0; row < layout.rows; row++) {
                        for (let col = 0; col < layout.columns; col++) {
                            const luminaire = document.createElement('div');
                            luminaire.className = 'luminaire';
                            
                            const x = (col * layout.spacingX + layout.wallOffsetX) / length * 90 + 5;
                            const y = (row * layout.spacingY + layout.wallOffsetY) / width * 90 + 5;
                            
                            luminaire.style.left = `${x}%`;
                            luminaire.style.top = `${y}%`;
                            
                            visualization.appendChild(luminaire);
                        }
                    }
                } else {
                    let luminaireCount = 0;
                    
                    for (let row = 0; row < layout.rows; row++) {
                        const lightsInThisRow = layout.rowPattern[row];
                        
                        for (let col = 0; col < lightsInThisRow; col++) {
                            const luminaire = document.createElement('div');
                            luminaire.className = 'luminaire';
                            
                            const rowCenterOffset = (layout.columns - lightsInThisRow) * layout.spacingX / 2;
                            const x = (col * layout.spacingX + layout.wallOffsetX + rowCenterOffset) / length * 90 + 5;
                            const y = (row * layout.spacingY + layout.wallOffsetY) / width * 90 + 5;
                            
                            luminaire.style.left = `${x}%`;
                            luminaire.style.top = `${y}%`;
                            
                            visualization.appendChild(luminaire);
                            luminaireCount++;
                            
                            if (luminaireCount >= layout.totalLuminaires) break;
                        }
                        
                        if (luminaireCount >= layout.totalLuminaires) break;
                    }
                }
            }

            function generateLayoutInfo(layout, length, width, mountingHeight, workingPlaneHeight, unit) {
                const workingHeight = Math.max(0.1, mountingHeight - workingPlaneHeight);
                const spacingHeightRatioX = layout.spacingX / workingHeight;
                const spacingHeightRatioY = layout.spacingY / workingHeight;
                
                let layoutDescription = '';
                if (layout.layoutType === 'grid') {
                    layoutDescription = `${layout.rows} √ó ${layout.columns} grid`;
                } else {
                    layoutDescription = `Staggered pattern: ${layout.rowPattern.join('-')}`;
                }
                
                layoutInfo.innerHTML = `
                    <div class="layout-card">
                        <h4>üìê Grid Configuration</h4>
                        <p><strong>Pattern:</strong> ${layoutDescription}</p>
                        <p><strong>Total Fixtures:</strong> ${layout.totalLuminaires}</p>
                        <p><strong>Layout Type:</strong> ${layout.layoutType === 'grid' ? 'Uniform Grid' : 'Staggered Pattern'}</p>
                    </div>
                    <div class="layout-card">
                        <h4>üìè Spacing Details</h4>
                        <p><strong>X-Spacing:</strong> ${layout.spacingX.toFixed(2)} ${unit}</p>
                        <p><strong>Y-Spacing:</strong> ${layout.spacingY.toFixed(2)} ${unit}</p>
                        <p><strong>Wall Offset:</strong> ${layout.wallOffsetX.toFixed(2)} ${unit}</p>
                    </div>
                `;
            }
            
            function updateSummary(calculationMode, area, lumensPerFixture, uf, mf, numLuminaires, achievedLux, targetLux) {
                summaryDiv.style.display = 'block';
                summaryContent.innerHTML = '';
                
                const baseItems = [
                    { label: 'Room Area', value: `${area.toFixed(1)} m¬≤` },
                    { label: 'Lumens/Fixture', value: `${lumensPerFixture} lm` },
                    { label: 'Utilization', value: `${(uf * 100).toFixed(0)}%` },
                    { label: 'Dialux Multiplier', value: DIALUX_MULTIPLIER.toFixed(3) }
                ];
                
                if (calculationMode === 'calcLuminaires') {
                    baseItems.push(
                        { label: 'Target Lux', value: `${targetLux} lux` },
                        { label: 'Luminaires Needed', value: numLuminaires },
                        { label: 'Achieved Lux', value: `${achievedLux.toFixed(0)} lux` }
                    );
                } else {
                    baseItems.push(
                        { label: 'Luminaires Used', value: numLuminaires },
                        { label: 'Achieved Lux', value: `${achievedLux.toFixed(0)} lux` }
                    );
                }
                
                baseItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'summary-item';
                    itemDiv.innerHTML = `
                        <div class="summary-value">${item.value}</div>
                        <div class="summary-label">${item.label}</div>
                    `;
                    summaryContent.appendChild(itemDiv);
                });
            }
            
            // Copy functionality
            copyBtn.addEventListener('click', function() {
                const resultText = document.getElementById('result').innerText;
                const summaryText = document.getElementById('summary').innerText;
                const fullText = `LIGHTING CALCULATION RESULTS\n${summaryText}\n\nDETAILED RESULTS:\n${resultText}`;
                
                navigator.clipboard.writeText(fullText).then(() => {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = '‚úÖ Copied!';
                    copyBtn.classList.add('copied');
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    copyBtn.textContent = '‚ùå Failed to copy';
                });
            });

            // Print functionality
            printBtn.addEventListener('click', function() {
                window.print();
            });

            document.getElementById('lightingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                document.querySelectorAll('.error').forEach(error => error.style.display = 'none');
                layoutContainer.style.display = 'none';
                actionButtons.style.display = 'none';
                
                // Show loading state
                submitSpinner.style.display = 'inline-block';
                submitBtn.disabled = true;
                document.getElementById('lightingForm').classList.add('loading');

                // Use setTimeout to allow UI to update
                setTimeout(() => {
                    try {
                        // Get common values
                        let length = parseFloat(document.getElementById('length').value);
                        let width = parseFloat(document.getElementById('width').value);
                        let height = parseFloat(document.getElementById('height').value);
                        const mountingHeight = parseFloat(document.getElementById('mountingHeight').value);
                        const workingPlaneHeight = parseFloat(document.getElementById('workingPlaneHeight').value);
                        const ceilingReflect = parseFloat(document.getElementById('ceilingReflect').value);
                        const wallReflect = parseFloat(document.getElementById('wallReflect').value);
                        const floorReflect = parseFloat(document.getElementById('floorReflect').value);
                        const unit = document.querySelector('input[name="unit"]:checked').value;
                        const calculationMode = objectiveInput.value;

                        // Validation
                        let hasErrors = false;
                        const fieldsToValidate = {
                            length: length, width: width, height: height,
                            mountingHeight: mountingHeight, workingPlaneHeight: workingPlaneHeight,
                            ceilingReflect: ceilingReflect, wallReflect: wallReflect, floorReflect: floorReflect
                        };
                        
                        for(const field in fieldsToValidate) {
                            if(isNaN(fieldsToValidate[field]) || fieldsToValidate[field] < 0) {
                                document.getElementById(`${field}Error`).style.display = 'block';
                                hasErrors = true;
                            }
                        }
                        
                        if (mountingHeight > height) {
                            document.getElementById('mountingHeightRoomError').style.display = 'block';
                            hasErrors = true;
                        }
                        
                        if (workingPlaneHeight >= mountingHeight) {
                            document.getElementById('workingPlaneMountingError').style.display = 'block';
                            hasErrors = true;
                        }
                        
                        let selectedLumens;
                        const lightSource = document.getElementById('lightSource').value;
                        if (lightSource === 'predefined') {
                            selectedLumens = parseFloat(document.getElementById('lightType').value);
                        } else {
                            selectedLumens = parseFloat(customLumensInput.value);
                            if (isNaN(selectedLumens) || selectedLumens <= 0) {
                                document.getElementById('lumensError').style.display = 'block';
                                hasErrors = true;
                            }
                        }
                        
                        let targetLux, numLuminaires;
                        if (calculationMode === 'calcLuminaires') {
                            targetLux = parseFloat(targetLuxInput.value);
                            if (isNaN(targetLux) || targetLux <= 0) {
                                document.getElementById('luxError').style.display = 'block';
                                hasErrors = true;
                            }
                        } else {
                            numLuminaires = parseFloat(numLuminairesInput.value);
                            if (isNaN(numLuminaires) || numLuminaires < 1 || numLuminaires % 1 !== 0) {
                                document.getElementById('numLuminairesError').style.display = 'block';
                                hasErrors = true;
                            }
                        }
                        
                        if (hasErrors) {
                            submitSpinner.style.display = 'none';
                            submitBtn.disabled = false;
                            document.getElementById('lightingForm').classList.remove('loading');
                            return;
                        }
                        
                        // Unit Conversion to Meters
                        let calcLength = length, calcWidth = width, calcHeight = height;
                        let calcMountingHeight = mountingHeight, calcWorkingPlaneHeight = workingPlaneHeight;
                        let displayUnit = 'm';
                        let areaUnit = 'm¬≤';
                        
                        if (unit === 'feet') {
                            [calcLength, calcWidth, calcHeight, calcMountingHeight, calcWorkingPlaneHeight] = 
                            [length, width, height, mountingHeight, workingPlaneHeight].map(v => v * FEET_TO_METERS);
                            displayUnit = 'ft'; 
                            areaUnit = 'ft¬≤';
                        } else if (unit === 'mm') {
                            [calcLength, calcWidth, calcHeight, calcMountingHeight, calcWorkingPlaneHeight] = 
                            [length, width, height, mountingHeight, workingPlaneHeight].map(v => v * MM_TO_METERS);
                            displayUnit = 'mm'; 
                            areaUnit = 'mm¬≤';
                        }
                        
                        const displayArea = (calcLength * calcWidth).toFixed(2);
                        
                        // Core Calculations
                        const roomArea = calcLength * calcWidth;
                        const roomIndex = calculateRoomIndex(calcLength, calcWidth, calcMountingHeight, calcWorkingPlaneHeight);
                        const uf = estimateUF(roomIndex, ceilingReflect, wallReflect);
                        const mf = 0.8;
                        
                        let resultHTML = '';
                        const commonDetails = `
                            <strong>Room Details:</strong><br>
                            Area: ${displayArea} ${areaUnit}<br>
                            <hr>
                            <strong>Calculated Parameters:</strong><br>
                            Room Index (K): <b>${roomIndex.toFixed(2)}</b><br>
                            Utilization Factor (UF): <b>${(uf * 100).toFixed(1)}%</b><br>
                            Maintenance Factor (MF): <b>${(mf * 100).toFixed(0)}%</b><br>
                            Dialux Alignment Multiplier: <b>${DIALUX_MULTIPLIER.toFixed(3)}</b><br>
                            <hr>`;

                        if (calculationMode === 'calcLuminaires') {
                            targetLux = parseFloat(targetLuxInput.value);
                            numLuminaires = calculateLuminaires(targetLux, roomArea, selectedLumens, uf, mf);
                            const achievedLux = (numLuminaires * selectedLumens * uf * mf * DIALUX_MULTIPLIER) / roomArea;
                            
                            let configTable = '<table><tr><th># of Lights</th><th>Achieved Lux</th></tr>';
                            for (let n = 1; n <= 10; n++) {
                                const lux = (n * selectedLumens * uf * mf * DIALUX_MULTIPLIER) / roomArea;
                                configTable += `<tr><td>${n}</td><td>${lux.toFixed(1)}</td></tr>`;
                            }
                            configTable += '</table>';
                            
                            resultHTML = `
                                ${commonDetails}
                                <strong>Lighting Results:</strong><br>
                                Number of luminaires needed: <b>${isFinite(numLuminaires) ? numLuminaires : 'N/A'}</b><br>
                                This will achieve an illuminance of: <b>${achievedLux.toFixed(1)} lux</b><br>
                                <hr>
                                <strong>Illuminance Table for Selected Luminaire (${selectedLumens} lm):</strong><br>
                                ${configTable}
                            `;
                            
                            updateSummary(calculationMode, roomArea, selectedLumens, uf, mf, numLuminaires, achievedLux, targetLux);
                            
                            if (isFinite(numLuminaires) && numLuminaires > 0) {
                                const layout = calculateOptimalLayout(calcLength, calcWidth, numLuminaires);
                                generateLayoutVisualization(layout, calcLength, calcWidth, displayUnit);
                                generateLayoutInfo(layout, calcLength, calcWidth, calcMountingHeight, calcWorkingPlaneHeight, displayUnit);
                                layoutContainer.style.display = 'block';
                            }
                        } else {
                            numLuminaires = parseInt(numLuminairesInput.value);
                            const achievedLux = (numLuminaires * selectedLumens * uf * mf * DIALUX_MULTIPLIER) / roomArea;
                            
                            resultHTML = `
                                ${commonDetails}
                                <strong>Lighting Result:</strong><br>
                                Using <b>${numLuminaires}</b> luminaire(s) will achieve an illuminance of:<br>
                                <h2 style="text-align:center; color:#0078d4; margin:10px 0;">${achievedLux.toFixed(1)} lux</h2>
                            `;
                            
                            updateSummary(calculationMode, roomArea, selectedLumens, uf, mf, numLuminaires, achievedLux);
                            
                            const layout = calculateOptimalLayout(calcLength, calcWidth, numLuminaires);
                            generateLayoutVisualization(layout, calcLength, calcWidth, displayUnit);
                            generateLayoutInfo(layout, calcLength, calcWidth, calcMountingHeight, calcWorkingPlaneHeight, displayUnit);
                            layoutContainer.style.display = 'block';
                        }
                        
                        const resultDiv = document.getElementById('result');
                        resultDiv.style.display = 'block';
                        resultDiv.innerHTML = resultHTML;
                        actionButtons.style.display = 'block';
                        
                    } catch (error) {
                        console.error('Calculation error:', error);
                        document.getElementById('result').innerHTML = '<div style="color: #d32f2f;">An error occurred during calculation. Please check your inputs.</div>';
                    } finally {
                        // Hide loading state
                        submitSpinner.style.display = 'none';
                        submitBtn.disabled = false;
                        document.getElementById('lightingForm').classList.remove('loading');
                    }
                }, 100); // Small delay to show loading state
            });
            
            initializeForm();
        });
    </script>
</body>
</html>